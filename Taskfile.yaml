version: "3"

tasks:
  # ────────────────────────────────────────
  # ヘルプ
  # ────────────────────────────────────────
  default:
    desc: クイックガイド
    cmds:
      - |
        cat <<'EOF'
        ■ セットアップ（初回のみ）
          task setup

        ■ 開発・実行
          task dev                      ローカル実行
          task up                       systemd起動
          task down                     systemd停止
          task restart                  systemd再起動
          task status                   全体状態確認
          task logs                     ログ追尾

        ■ 録音・処理（メイン機能）
          task record                   手動録音
          task process FILE=録音.wav    1ファイル処理
          task process:all              全録音を一括処理

        ■ 小説生成
          task novel:build              今日の要約から章を生成
          task novel:build date=YYYYMMDD 指定日の章を生成
          task photo novel=data/novels/YYYYMMDD.md 小説から画像生成
          task photos:all               全小説から画像を一括生成

        ■ Windows 起動
          ダブルクリック: windows\run.bat
        ■ 初回セットアップ（管理者権限で実行）
          windows\bootstrap.bat

        ■ データ同期
          task sync                     Supabase同期
          task sync:full                全件強制同期

        ■ Web UI
          task web:dev                  開発サーバー
          task web:build                本番ビルド
          task web:deploy               Vercelデプロイ

        ■ メンテナンス
          task lint                     コード品質チェック
          task clean                    キャッシュ削除
          task commit MESSAGE="..."     Git commit

        ■ デバッグ用
          task service:status           systemd状態のみ
          task log:status               ログ解析のみ
          task transcribe FILE=...      文字起こしのみ
          task summarize FILE=...       要約のみ
        EOF

  # ────────────────────────────────────────
  # セットアップ
  # ────────────────────────────────────────
  setup:
    desc: 依存同期
    cmd: uv sync

  # ────────────────────────────────────────
  # 開発・実行
  # ────────────────────────────────────────
  dev:
    desc: アプリ実行
    cmd: uv run python -m src.main

  up:
    desc: systemd起動
    cmd: systemctl --user enable --now "$(pwd)/vlog.service"

  down:
    desc: systemd停止
    cmd: systemctl --user disable --now vlog.service

  restart:
    desc: systemd再起動
    cmd: systemctl --user restart vlog

  status:
    desc: 全体状態確認（service + log）
    cmds:
      - echo "■ systemd 状態"
      - systemctl --user status vlog --no-pager --lines=10 || true
      - echo ""
      - echo "■ ログ解析"
      - python3 src/view_logs.py

  logs:
    desc: ログ追尾（リアルタイム）
    cmd: journalctl --user -u vlog -f

  # ────────────────────────────────────────
  # 録音・処理
  # ────────────────────────────────────────
  record:
    desc: 手動録音開始
    cmd: uv run python -m src.cli record

  process:
    desc: 録音→要約（単一ファイル）
    deps: [require_file]
    cmds: ["uv run python -m src.cli process --file {{.FILE}}"]

  process:all:
    desc: 録音→要約（全ファイル一括）
    cmds:
      - for f in data/recordings/*.wav data/recordings/*.flac; do [ -f "$f" ] && task process FILE="$f"; done || true

  process:today:
    desc: 今日の録音を一括処理（要約は再生成）
    cmds:
      - |
        TODAY=$(date +%Y%m%d)
        rm -f data/summaries/${TODAY}_summary.txt
        for f in data/recordings/${TODAY}*.wav data/recordings/${TODAY}*.flac; do
          [ -f "$f" ] && task process FILE="$f"
        done || true

  transcribe:all:
    desc: 文字起こしのみ（全ファイル）
    cmds:
      - for f in data/recordings/*.wav data/recordings/*.flac; do [ -f "$f" ] && task transcribe FILE="$f"; done || true

  # ────────────────────────────────────────
  # データ同期
  # ────────────────────────────────────────
  sync:
    desc: Supabase同期
    cmd: uv run python -m src.cli sync

  sync:full:
    desc: 全件強制同期
    cmds:
      - touch data/summaries/*.txt
      - task sync

  # ────────────────────────────────────────
  # Web UI
  # ────────────────────────────────────────
  web:dev:
    desc: 開発サーバー
    cmd: cd frontend/reader && npm run dev -- --hostname 0.0.0.0 --port 3000

  web:build:
    desc: ビルド
    cmd: cd frontend/reader && npm run build

  web:start:
    desc: 本番起動（ポート4000）
    cmd: cd frontend/reader && npm run start -- --hostname 0.0.0.0 --port 4000

  web:deploy:
    desc: Vercelデプロイ
    cmds:
      - cd frontend/reader && npx vercel link --project kaflog --yes
      - cd frontend/reader && npx vercel --prod --yes

  web:env:
    desc: 環境変数抽出
    cmds:
      - test -f .env || (echo ".env がありません" && exit 1)
      - |
        . ./.env
        cat >frontend/reader/.env.local <<EOF
        NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        EOF

  # ────────────────────────────────────────
  # メンテナンス
  # ────────────────────────────────────────
  lint:
    desc: コード品質チェック
    cmds: ["uv run ruff check src && uv run ruff format src"]

  clean:
    desc: キャッシュ削除
    cmds:
      [
        "rm -rf __pycache__ .ruff_cache && find . -type d -name __pycache__ -exec rm -rf {} + || true",
      ]

  commit:
    desc: Git commit
    cmds: ["git add . && git commit -am '{{.MESSAGE}}'"]

  # ────────────────────────────────────────
  # デバッグ用
  # ────────────────────────────────────────
  service:status:
    desc: systemd状態のみ
    cmd: systemctl --user status vlog

  log:status:
    desc: ログ解析のみ
    cmd: python3 src/view_logs.py

  transcribe:
    desc: 文字起こしのみ
    deps: [require_file]
    cmds: ["uv run python -m src.cli transcribe --file {{.FILE}}"]

  summarize:
    desc: 要約のみ
    deps: [require_file]
    cmds: ["uv run python -m src.cli summarize --file {{.FILE}}"]

  # ────────────────────────────────────────
  # 小説生成
  # ────────────────────────────────────────
  novel:build:
    desc: 小説の章を生成
    cmds:
      - uv run python -m src.cli novel {{if .date}}--date {{.date}}{{end}}

  photo:
    desc: 小説から画像を生成
    cmds:
      - uv run python -m src.cli image-generate --novel-file {{.novel}} --output-file data/photos/$(basename {{.novel}} .md).png
    preconditions:
      - sh: test -n "{{.novel}}"
        msg: novel=data/novels/YYYYMMDD.mdを指定してください

  photos:all:
    desc: 全小説から画像を一括生成
    cmds:
      - for f in data/novels/*.md; do [ -f "$f" ] && task photo novel="$f"; done || true

  # ────────────────────────────────────────
  # 内部ヘルパー
  # ────────────────────────────────────────
  require_file:
    internal: true
    preconditions:
      - sh: test -n "{{.FILE}}"
        msg: FILEを指定してください
